# Firebase Setup Guide for MAP Certificate

## Overview

Yes, you need to create a Firebase project and enable the Web App. This guide walks you through the complete Firebase setup process.

## ðŸš€ Step-by-Step Firebase Setup

### Step 1: Create Firebase Project (5 minutes)

1. **Go to Firebase Console**
   - Visit: https://console.firebase.google.com/
   - Sign in with your Google account

2. **Create New Project**
   - Click **"Add project"** or **"Create a project"**
   - Enter project name: `map-certificate` (or your preferred name)
   - Click **"Continue"**

3. **Google Analytics (Optional)**
   - Choose whether to enable Google Analytics
   - For production, it's recommended
   - Click **"Continue"**

4. **Wait for Project Creation**
   - Firebase will create your project (takes ~30 seconds)
   - Click **"Continue"** when ready

---

### Step 2: Register Web App (3 minutes)

1. **Add Web App**
   - In your Firebase project dashboard
   - Click the **Web icon** `</>` to add a web app
   - Or go to: Project Settings > General > Your apps

2. **Register App**
   - App nickname: `MAP Certificate Web App`
   - âœ… Check **"Also set up Firebase Hosting"** (optional but recommended)
   - Click **"Register app"**

3. **Copy Firebase Configuration**
   - Firebase will show you configuration code like this:
   
   ```javascript
   const firebaseConfig = {
     apiKey: "AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
     authDomain: "map-certificate.firebaseapp.com",
     projectId: "map-certificate",
     storageBucket: "map-certificate.appspot.com",
     messagingSenderId: "123456789012",
     appId: "1:123456789012:web:abcdef1234567890"
   };
   ```
   
   - **COPY THIS** - you'll need it!
   - Click **"Continue to console"**

---

### Step 3: Enable Firestore Database (3 minutes)

1. **Navigate to Firestore**
   - In Firebase Console, left sidebar
   - Click **"Firestore Database"**
   - Click **"Create database"**

2. **Choose Location**
   - Select production mode (you can change security rules later)
   - Choose location closest to your users (e.g., `asia-south1` for Maldives)
   - Click **"Enable"**

3. **Create Collections**
   - Once Firestore is ready, create these collections:
   
   **Collection 1: `certificate_templates`**
   - Click **"Start collection"**
   - Collection ID: `certificate_templates`
   - Add first document (will be auto-generated by your app)
   - For now, just create the collection with a dummy document

   **Collection 2: `settings`**
   - Click **"Start collection"**
   - Collection ID: `settings`
   - Document ID: `certificate_config`
   - Add fields:
     ```
     certificatePrefix: "MAP"
     lastCertificateNumber: 0
     pdfResolution: 300
     ```

---

### Step 4: Enable Firebase Storage (2 minutes)

1. **Navigate to Storage**
   - In Firebase Console, left sidebar
   - Click **"Storage"**
   - Click **"Get started"**

2. **Security Rules**
   - Choose **"Start in production mode"**
   - Click **"Next"**

3. **Choose Location**
   - Use the same location as Firestore
   - Click **"Done"**

4. **Create Folders** (optional - will be created automatically)
   - Click **"Create folder"**
   - Create: `assets`
   - Create: `certificates`

---

### Step 5: Enable Authentication (5 minutes)

1. **Navigate to Authentication**
   - In Firebase Console, left sidebar
   - Click **"Authentication"**
   - Click **"Get started"**

2. **Enable Sign-in Methods**

   **For Admin Users (Office 365/Microsoft):**
   - Click **"Sign-in method"** tab
   - Click **"Microsoft"** provider
   - Click **"Enable"**
   - You'll need to register your app in Azure AD first (see below)

   **For Participants (Google):**
   - Click **"Google"** provider
   - Click **"Enable"**
   - Select support email
   - Click **"Save"**

3. **Add Authorized Domains**
   - In Authentication settings
   - Go to **"Settings"** tab > **"Authorized domains"**
   - Add your domains:
     - `familycourt.gov.mv` (your production domain)
     - `localhost` (already added for development)

---

### Step 6: Configure Firebase in Your App (5 minutes)

1. **Create Firebase Config File**

   Create `src/firebase.ts`:
   ```typescript
   import { initializeApp } from 'firebase/app';
   import { getFirestore } from 'firebase/firestore';
   import { getStorage } from 'firebase/storage';
   import { getAuth } from 'firebase/auth';

   const firebaseConfig = {
     apiKey: "YOUR_API_KEY",
     authDomain: "YOUR_AUTH_DOMAIN",
     projectId: "YOUR_PROJECT_ID",
     storageBucket: "YOUR_STORAGE_BUCKET",
     messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
     appId: "YOUR_APP_ID"
   };

   // Initialize Firebase
   const app = initializeApp(firebaseConfig);

   // Initialize services
   export const db = getFirestore(app);
   export const storage = getStorage(app);
   export const auth = getAuth(app);

   export default app;
   ```

2. **Add Environment Variables** (Recommended for production)

   Create `.env.local`:
   ```bash
   VITE_FIREBASE_API_KEY=your_api_key
   VITE_FIREBASE_AUTH_DOMAIN=your_auth_domain
   VITE_FIREBASE_PROJECT_ID=your_project_id
   VITE_FIREBASE_STORAGE_BUCKET=your_storage_bucket
   VITE_FIREBASE_MESSAGING_SENDER_ID=your_messaging_sender_id
   VITE_FIREBASE_APP_ID=your_app_id
   ```

   Update `src/firebase.ts`:
   ```typescript
   const firebaseConfig = {
     apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
     authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
     projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
     storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
     messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
     appId: import.meta.env.VITE_FIREBASE_APP_ID
   };
   ```

3. **Add to `.gitignore`**
   ```
   .env.local
   .env.production
   ```

---

### Step 7: Set Up Security Rules (10 minutes)

1. **Firestore Security Rules**

   Go to **Firestore Database** > **Rules** tab

   ```javascript
   rules_version = '2';
   service cloud.firestore {
     match /databases/{database}/documents {
       
       // Helper function to check if user is admin
       function isAdmin() {
         return request.auth != null && 
                request.auth.token.role == 'admin';
       }
       
       // Helper function to check if user is authenticated
       function isAuthenticated() {
         return request.auth != null;
       }
       
       // Certificate Templates - Admin only
       match /certificate_templates/{templateId} {
         allow read: if isAuthenticated();
         allow write: if isAdmin();
       }
       
       // Settings - Admin only
       match /settings/{docId} {
         allow read: if isAuthenticated();
         allow write: if isAdmin();
       }
       
       // Participants - Admin full access, users read own
       match /participants/{participantId} {
         allow read, write: if isAdmin();
         allow read: if isAuthenticated() && 
                        request.auth.token.email == resource.data.email;
       }
       
       // Email logs - Admin only
       match /email_logs/{logId} {
         allow read, write: if isAdmin();
       }
     }
   }
   ```

   Click **"Publish"**

2. **Firebase Storage Rules**

   Go to **Storage** > **Rules** tab

   ```javascript
   rules_version = '2';
   service firebase.storage {
     match /b/{bucket}/o {
       
       // Helper function to check if user is admin
       function isAdmin() {
         return request.auth != null && 
                request.auth.token.role == 'admin';
       }
       
       // Assets - Admin upload, public read
       match /assets/{type}/{filename} {
         allow read: if true; // Public read for certificate generation
         allow write: if isAdmin();
       }
       
       // Certificates - Admin write, authenticated users read own
       match /certificates/{year}/{month}/{filename} {
         allow read: if request.auth != null;
         allow write: if isAdmin();
       }
     }
   }
   ```

   Click **"Publish"**

---

### Step 8: Initialize Default Template (5 minutes)

1. **Create Initialization Script**

   Create `scripts/initializeTemplate.js`:
   ```javascript
   import { initializeApp } from 'firebase/app';
   import { getFirestore, collection, addDoc } from 'firebase/firestore';
   import { DEFAULT_A4_PORTRAIT_TEMPLATE } from '../src/utils/template.defaults.js';

   const firebaseConfig = {
     // Your Firebase config here
   };

   const app = initializeApp(firebaseConfig);
   const db = getFirestore(app);

   async function initializeDefaultTemplate() {
     try {
       const template = {
         ...DEFAULT_A4_PORTRAIT_TEMPLATE,
         createdBy: 'system',
         createdAt: new Date(),
         updatedAt: new Date(),
       };
       
       const docRef = await addDoc(collection(db, 'certificate_templates'), template);
       console.log('âœ… Default template created with ID:', docRef.id);
       process.exit(0);
     } catch (error) {
       console.error('âŒ Error creating template:', error);
       process.exit(1);
     }
   }

   initializeDefaultTemplate();
   ```

2. **Run Script**
   ```bash
   node scripts/initializeTemplate.js
   ```

---

### Step 9: Set Up Custom Claims for Admin Users (Optional but Recommended)

To set admin role for specific users, you'll need Firebase Admin SDK:

1. **Install Firebase Admin**
   ```bash
   npm install firebase-admin
   ```

2. **Create Admin Script**

   Create `scripts/setAdminClaim.js`:
   ```javascript
   const admin = require('firebase-admin');
   const serviceAccount = require('./serviceAccountKey.json');

   admin.initializeApp({
     credential: admin.credential.cert(serviceAccount)
   });

   async function setAdminClaim(email) {
     try {
       const user = await admin.auth().getUserByEmail(email);
       await admin.auth().setCustomUserClaims(user.uid, { role: 'admin' });
       console.log(`âœ… Admin role set for: ${email}`);
     } catch (error) {
       console.error('âŒ Error:', error);
     }
     process.exit(0);
   }

   // Replace with your admin email
   setAdminClaim('admin@familycourt.gov.mv');
   ```

3. **Get Service Account Key**
   - Firebase Console > Project Settings > Service Accounts
   - Click **"Generate new private key"**
   - Save as `scripts/serviceAccountKey.json`
   - **Never commit this file to git!**

4. **Run Script**
   ```bash
   node scripts/setAdminClaim.js
   ```

---

## âœ… Verification Checklist

After setup, verify everything works:

- [ ] Firebase project created
- [ ] Web app registered
- [ ] Firestore database enabled with collections
- [ ] Firebase Storage enabled
- [ ] Authentication enabled (Google, Microsoft)
- [ ] Security rules deployed
- [ ] Firebase config added to your app
- [ ] Default template initialized
- [ ] Admin claims set for your users
- [ ] App runs locally: `npm run dev`

---

## ðŸ“¦ Install Firebase Dependencies

```bash
npm install firebase
npm install firebase-admin --save-dev
```

---

## ðŸ” Azure AD Setup (For Office 365 Admin Login)

To enable Microsoft/Office 365 login for admin staff:

1. **Go to Azure Portal**
   - https://portal.azure.com/
   - Sign in with your organization account

2. **Register App**
   - Azure Active Directory > App registrations > New registration
   - Name: `MAP Certificate Admin`
   - Supported account types: **Single tenant**
   - Redirect URI: `https://YOUR_PROJECT.firebaseapp.com/__/auth/handler`
   - Click **"Register"**

3. **Get Credentials**
   - Copy **Application (client) ID**
   - Go to **Certificates & secrets**
   - Create new client secret
   - Copy the secret value

4. **Add to Firebase**
   - Firebase Console > Authentication > Sign-in method
   - Click **Microsoft**
   - Enter Application (client) ID and Client secret
   - Copy Redirect URI and add to Azure AD app

---

## ðŸš€ Quick Start Commands

```bash
# 1. Install dependencies
npm install

# 2. Create Firebase config file
# (Copy your config from Firebase Console)
touch src/firebase.ts

# 3. Initialize default template
node scripts/initializeTemplate.js

# 4. Set admin role for your email
node scripts/setAdminClaim.js

# 5. Start development server
npm run dev

# 6. Navigate to http://localhost:5173/admin/templates
```

---

## ðŸ’¡ Tips

1. **Use Firebase Emulators for Development**
   ```bash
   npm install -g firebase-tools
   firebase init emulators
   firebase emulators:start
   ```

2. **Monitor Usage**
   - Firebase Console > Usage and billing
   - Set up budget alerts

3. **Backup Firestore**
   - Set up automated backups in Firebase Console
   - Project Settings > Backup

4. **Test Security Rules**
   - Use Firebase Console's Rules Simulator
   - Write unit tests for rules

---

## ðŸ†˜ Troubleshooting

### Can't connect to Firebase?
- Check firebaseConfig values
- Verify API key is correct
- Check network/firewall settings

### Authentication not working?
- Verify authorized domains in Firebase Console
- Check OAuth provider configuration
- Ensure redirect URIs are correct

### Permission denied errors?
- Check Firestore/Storage security rules
- Verify user has correct custom claims
- Check authentication state

---

## ðŸ“š Additional Resources

- [Firebase Documentation](https://firebase.google.com/docs)
- [Firebase Setup Guide](https://firebase.google.com/docs/web/setup)
- [Firestore Security Rules](https://firebase.google.com/docs/firestore/security/get-started)
- [Firebase Storage Rules](https://firebase.google.com/docs/storage/security)
- [Firebase Authentication](https://firebase.google.com/docs/auth)

---

**Setup Time: ~30-40 minutes**

Once complete, your Firebase backend will be ready for the certificate template system! ðŸŽ‰
